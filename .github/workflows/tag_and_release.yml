name: Tag and Release

on:
  push: 
    branches: main
  pull_request:
    branches: main
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write
  id-token: write 

jobs:

  # Set a version tag on the repo, also used for naming the machine image to use. 
  tag:
    runs-on: ubuntu-latest
    steps: 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Semantic Release
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          semantic_version: v21.1.1
          branches: |
              [
                'main'
              ]
          extra_plugins: |
            @semantic-release/git
            @semantic-release/changelog
            @semantic-release/exec
            conventional-changelog-conventionalcommits@6.1.0      
            
      - name: Create floating tag
        if: ${{ steps.semantic-release.outputs.new_release_published == 'true' }}
        uses: 'actions/github-script@v7'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |-
            const sha = process.env.GITHUB_SHA;
            const major = '${{ steps.semantic-release.outputs.new_release_major_version }}';
            const tag = `v${major}`;

            // If exists then update, else create
            try {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`,
                sha: sha,
                force: true,
              });
              core.info(`Updated ${tag} to ${sha}`);
            } catch(err) {
              core.info(`Failed to update ${tag}: ${err}`);
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: sha,
              });
              core.info(`Created ${tag} at ${sha}`);
            }
